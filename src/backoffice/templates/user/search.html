{% extends 'base.html' %}
{% load static from staticfiles %}
{% load qrcode %}

{% block content %}

<form id="search_form" method="POST" action="">
    {% csrf_token %}

    <div class="row">

        <div class="col-md-12">
            <h3>Scan the ticket!</h3>
            <input type="text" name="ticket_token" id="ticket_token_input" autocomplete="off" style="color: #fff; background: #fff; border: 0; height: 0; width: 0;"/>

            <span id="scan_again" hidden>Scan again!</span>

        </div>

    </div>

</form>

{% if ticket %}
    {{ ticket }}<br />
    <br />
    Checked in?: {{ ticket.checked_in }}

    <hr />
    <form id="check_in_form" method="POST" action="">{% csrf_token %}
    <input type="input" name="check_in_ticket_id" id="check_in_input" value="{{ ticket.pk }}" style="color: #fff; background: #fff; border: 0; height: 0; width: 0;"/>
    </form>

    <div class="row">
        <div class="col-md-6">
            {% qr_code "clear" %}
        </div>

        <div class="col-md-6">
            {% qr_code "check-in" %}
        </div>
    </divc>
{% endif %}



<script>

document.addEventListener('DOMContentLoaded', () => {
    'use strict';

    const search_form = document.getElementById('search_form');
    const ticket_token_input = document.getElementById('ticket_token_input');
    const scan_again = document.getElementById('scan_again');

    const check_in_input = document.getElementById('check_in_input');
    const check_in_form = document.getElementById('check_in_form');

    search_form.onsubmit = submit;

    function submit(e) {
        e.preventDefault();

        console.log(ticket_token_input.value);

        if(ticket_token_input.value === "#clear") {
            window.location.replace(window.location.pathname);
        } else if(ticket_token_input.value === "#check-in") {
            check_in_input.checked = true;
            check_in_form.submit();
        } else if(ticket_token_input.value.length === 65) {
            search_form.submit();
        } else {
            scan_again.removeAttribute('hidden');
        }
    };

    document.addEventListener('keydown', event => {
        if(event.key === '#') {
            ticket_token_input.value = "";
            ticket_token_input.focus();
        }
    });

});

</script>

{% endblock content %}

